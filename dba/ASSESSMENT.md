一、评估背景
本次评估基于 “同一 PostgreSQL 实例支撑内部 OA 系统 + 外部智能体产品” 的数据库设计方案，从表结构、字段、索引、权限、扩展性等维度，快速评估当前设计的合理性、潜在风险及优先级，为后续运维和优化提供依据。
二、数据库结构合理性评估
2.1 整体结构（Schema + 表）：合理，符合初期业务诉求
评估维度	合理性分析	优化建议
Schema 隔离	按 “internal_oa/external_agent” 拆分，物理隔离内 / 外部业务，兼顾成本与隔离性	可新增pg_cron定时清理外部业务过期日志，减少公共 Schema 依赖
表拆分逻辑	内部 OA 聚焦 “用户 / 角色 / 审计”，外部业务聚焦 “租户 / 用户 / 智能体数据”，职责清晰	外部业务可新增agent_data_history表，分离高频读写数据
表命名规范	前缀统一（如 internal_oa.operation_audit、external_agent.tenant_*），易识别	补充表 / 字段的中文注释，降低新人接手成本
2.2 字段设计：核心合理，局部需补充
业务类型	合理点	待优化点
内部 OA	审计表包含operation_type/ip_address/operation_content，满足追溯要求；用户表关联role_id，适配 RBAC 模型	缺少deleted_at（软删除）字段，删除操作无法追溯；密码未存储哈希盐值
外部业务	租户表tenant_code唯一、用户表uk_tenant_user约束，防止租户内账号重复；tenant_id作为核心隔离字段	agent_data.data_content为 TEXT 类型，无长度限制，易存储大文本拖慢查询；缺少updated_at字段，无法追踪数据更新时间
2.3 索引设计：核心索引覆盖，局部缺失	
评估维度	合理性分析	缺失索引
核心索引	审计表idx_audit_user_id/idx_audit_operation_time、外部业务idx_tenant_agent_id覆盖高频查询	内部 OA：internal_oa.users.role_id（角色维度查询频繁）；外部业务：external_agent.users.tenant_id（租户维度用户查询）
索引有效性	主键索引（如 user_id/tenant_id）、唯一索引（如 username/tenant_code）覆盖核心唯一约束	避免在data_content等大字段建索引，优先使用前缀索引
2.4 权限模型：架构合理，落地需严格执行
评估维度	合理性分析	风险提示
DB 用户隔离	按业务拆分oa_app_user/agent_app_user/audit_read_user，最小权限原则	需禁止所有应用用户使用SUPERUSER权限，定期核查权限
RLS 行级隔离	外部业务通过tenant_id+RLS 控制租户数据，适配多租户场景	需验证应用层是否严格传递app.tenant_id，防止越权
三、最可能优先出问题的风险点
3.1 高优先级（1-2 个月内大概率触发）
1.外部业务agent_data表性能问题
风险描述：agent_data无updated_at字段，且data_content为 TEXT 类型无长度限制，外部用户量增长后，大文本存储会导致单表体积快速膨胀，高频查询（如按agent_id筛选）响应变慢；
触发场景：外部智能体用户日活＞1000，或单租户单日产生＞1 万条智能体交互数据。
2.审计表写入性能瓶颈
风险描述：内部 OA 所有操作均写入operation_audit，且无分表策略，当内部员工操作频次增加（如每日＞1 万次），审计表单表数据量快速增长，operation_time索引失效，审计查询（如按时间范围查操作记录）耗时＞5 秒；
触发场景：内部 OA 日活＞500，或每月操作记录＞30 万条。
3.权限配置落地不严格
风险描述：若应用层未严格限制app.tenant_id传递，或 DB 用户权限未回收干净（如agent_app_user仍有internal_oa的 USAGE 权限），可能导致外部业务访问内部 OA 数据，或租户间数据泄露；
触发场景：运维人员误配置权限，或应用代码漏洞导致tenant_id被篡改。
3.2 中优先级（3-6 个月可能触发）
1.资源竞争导致内部 OA 响应变慢
风险描述：同一实例下，外部业务高频读写（如智能体数据查询）占用 CPU/IO 资源，导致内部 OA 的审计表写入、用户权限查询等操作延迟增加；
触发场景：外部业务 QPS＞1000，或单条慢查询（如无索引的agent_data全表扫描）阻塞实例。
2.软删除缺失导致数据恢复困难
风险描述：内部 OA 用户 / 角色表、外部租户表无deleted_at软删除字段，物理删除后无法恢复，易因误操作导致数据丢失；
触发场景：运维 / 开发人员误删除内部员工账号或外部租户数据。
四、当前业务阶段可接受的问题（无需立即处理）
问题描述	可接受原因	处理时机
外部业务agent_data未做分表 / 分区	初期用户量小，单表数据量＜10 万行，分表会增加运维复杂度；PostgreSQL 分区表需提前规划，初期无需过度设计	外部业务数据量＞100 万行，或查询耗时＞2 秒
公共 Schema 存在少量枚举表，未完全隔离	初期跨业务枚举数据少（如操作类型、权限类型），完全隔离会增加代码适配成本	枚举表数量＞10 张，或跨业务修改枚举频率增加
内部 OA 密码仅存储哈希值，无哈希盐值	初期内部员工量少，密码破解风险低；添加盐值需修改用户表和登录逻辑，可后期迭代	内部员工量＞1000，或等保合规要求提升
外部业务审计日志仅落地数据库，未接入 ELK		初期外部业务操作频次低，数据库审计表可满足查询需求；ELK 接入需额外资源投入	外部业务日审计记录＞5 万条，或需实时日志分析
五、不处理必出事故的问题（必须立即整改）
问题描述	事故风险	整改方案
外部业务agent_data缺少updated_at字段，且data_content无长度限制	无法追踪数据更新时间，大文本导致表膨胀、查询性能雪崩；极端场景下单条数据＞10MB，拖垮实例	1. 新增updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP；
2. data_content改为VARCHAR(4096)（按业务场景调整长度）；
3. 新增ext_info JSONB存储额外大字段，按需查询
审计表（internal_oa.operation_audit）无写入限流 / 批量写入机制	内部 OA 高频操作（如批量权限修改）导致审计表写入突增，阻塞数据库；单条写入失败会导致业务操作回滚	1. 应用层实现审计日志批量写入（每 100 条批量提交）；
2. 数据库层面为审计表设置WRITE性能阈值，超限告警
DB 用户权限未做定期核查机制	权限泄露 / 误配置无法及时发现，可能导致内 / 外部数据泄露；违反最小权限原则	1. 新增pg_cron定时任务，每周核查 DB 用户权限；
2. 建立权限变更审批流程，禁止直接修改生产库权限
外部业务 RLS 策略未做全量测试，存在越权访问风险	租户 A 可访问租户 B 的数据，违反多租户隔离要求，引发数据泄露事故	1. 编写 RLS 策略测试用例（覆盖租户 ID 篡改、空值、超权查询）；
2. 应用层添加tenant_id二次校验，不依赖数据库 RLS 单

